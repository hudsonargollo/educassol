# Implementation Plan

- [x] 1. Set up database schema and storage
  - [x] 1.1 Create database migration for exams, submissions, and results tables
    - Create SQL migration file with table definitions, indexes, and RLS policies
    - Include generated column for total_score extraction from JSONB
    - _Requirements: 1.1, 7.3_
  - [x] 1.2 Create Supabase Storage buckets for raw-exams and graded-reports
    - Configure bucket policies for authenticated access
    - _Requirements: 2.3, 5.4_
  - [x] 1.3 Update TypeScript types for new database tables
    - Add types to src/integrations/supabase/types.ts
    - _Requirements: 1.1, 4.4_

- [x] 2. Implement core validation and utility functions
  - [x] 2.1 Create rubric validation module
    - Implement validateRubric function with Zod schema
    - Export RubricQuestion and Rubric TypeScript interfaces
    - _Requirements: 1.2_
  - [x] 2.2 Write property test for rubric validation
    - **Property 2: Rubric validation correctness**
    - **Validates: Requirements 1.2**
  - [x] 2.3 Create grading result schema and validation
    - Implement GradingResult, QuestionResult, StudentMetadata interfaces
    - Create parseGradingResult function with validation
    - _Requirements: 4.1, 4.2, 4.3_
  - [x] 2.4 Write property test for grading result schema
    - **Property 9: Grading result schema validation**
    - **Validates: Requirements 4.1, 4.2, 4.3**
  - [x] 2.5 Write property test for grading result serialization round-trip
    - **Property 10: Grading result serialization round-trip**
    - **Validates: Requirements 4.4, 4.5**
  - [x] 2.6 Create file validation utilities
    - Implement validateFileType and validateFileSize functions
    - _Requirements: 2.1, 2.2_
  - [x] 2.7 Write property tests for file validation
    - **Property 4: File type validation**
    - **Property 5: File size validation**
    - **Validates: Requirements 2.1, 2.2**
  - [x] 2.8 Create storage path generator utility
    - Implement generateStoragePath function
    - _Requirements: 2.3_
  - [x] 2.9 Write property test for storage path structure
    - **Property 6: Storage path structure**
    - **Validates: Requirements 2.3**

- [x] 3. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 4. Implement upload-exam Edge Function
  - [x] 4.1 Create upload-exam function scaffold
    - Set up Deno imports, CORS headers, auth validation
    - Follow existing Edge Function patterns from generate-lesson-plan
    - _Requirements: 2.1, 2.2, 2.3, 2.4_
  - [x] 4.2 Implement multipart form data parsing
    - Parse file from request body
    - Extract exam_id and student_identifier from form fields
    - _Requirements: 2.4_
  - [x] 4.3 Implement file validation and storage
    - Validate MIME type and file size
    - Upload to Supabase Storage with correct path structure
    - _Requirements: 2.1, 2.2, 2.3_
  - [x] 4.4 Implement submission record creation
    - Insert submission record with storage_path and status
    - Return submission_id to client
    - _Requirements: 2.4_
  - [ ]* 4.5 Write property test for upload creates submission record
    - **Property 7: Upload creates submission record**
    - **Validates: Requirements 2.4**

- [x] 5. Implement analyze-exam Edge Function
  - [x] 5.1 Create analyze-exam function scaffold
    - Set up Deno imports, CORS headers, auth validation
    - _Requirements: 3.1, 3.2_
  - [x] 5.2 Implement file retrieval and Base64 conversion
    - Download file from Supabase Storage
    - Convert to Base64 string for Gemini API
    - _Requirements: 3.1_
  - [ ]* 5.3 Write property test for Base64 round-trip
    - **Property 8: Base64 conversion round-trip**
    - **Validates: Requirements 3.1**
  - [x] 5.4 Implement Gemini API integration
    - Construct prompt with rubric and system instructions
    - Configure response_mime_type and response_schema for JSON output
    - _Requirements: 3.2, 3.3_
  - [x] 5.5 Implement retry logic with exponential backoff
    - Handle API errors and timeouts
    - Retry up to 3 times with increasing delays
    - _Requirements: 3.5_
  - [x] 5.6 Implement result storage and status updates
    - Parse Gemini response and store in results table
    - Update submission status to graded or failed
    - _Requirements: 3.4, 3.6, 3.7_

- [x] 6. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 7. Implement generate-report Edge Function
  - [x] 7.1 Create generate-report function scaffold
    - Set up Deno imports for pdf-lib and qrcode
    - _Requirements: 5.1, 5.2_
  - [x] 7.2 Implement QR code generation
    - Generate verification URL with token
    - Create Base64 Data URI for embedding
    - _Requirements: 5.2, 5.3_
  - [x] 7.3 Implement PDF document generation
    - Create PDF using pdf-lib with report layout
    - Include student info, scores, feedback, and QR code
    - _Requirements: 5.1_
  - [x] 7.4 Implement PDF storage and URL update
    - Store generated PDF in graded-reports bucket
    - Update pdf_report_url in results table
    - _Requirements: 5.4_
  - [ ]* 7.5 Write property test for PDF report content
    - **Property 11: PDF report contains required content**
    - **Validates: Requirements 5.1, 5.2, 5.3**

- [x] 8. Implement verification page
  - [x] 8.1 Create VerificationPage React component
    - Public route at /verify with token parameter
    - _Requirements: 6.1, 6.2_
  - [x] 8.2 Implement token lookup and display
    - Query results by verification_token
    - Display student initials, exam title, date, score
    - Handle invalid tokens gracefully
    - _Requirements: 6.2, 6.3, 6.4_
  - [ ]* 8.3 Write property test for verification retrieval
    - **Property 12: QR code verification retrieves correct data**
    - **Validates: Requirements 6.1, 6.2, 6.3**

- [x] 9. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 10. Implement exam management UI
  - [x] 10.1 Create ExamCreator component
    - Form with title, description, class selector, rubric builder
    - Integrate with exams table via Supabase client
    - _Requirements: 1.1, 1.2_
  - [ ]* 10.2 Write property test for exam creation
    - **Property 1: Exam creation stores all required fields**
    - **Validates: Requirements 1.1**
  - [x] 10.3 Create exam list and detail views
    - Display exams with submission counts
    - Support exam editing and deletion
    - _Requirements: 1.3, 1.4, 1.5_
  - [ ]* 10.4 Write property test for exam updates preserve submissions
    - **Property 3: Exam updates preserve submissions**
    - **Validates: Requirements 1.3**

- [x] 11. Implement file upload UI
  - [x] 11.1 Create FileUploader component
    - Drag-and-drop interface with progress indicators
    - Support bulk file selection
    - _Requirements: 2.4, 2.5_
  - [x] 11.2 Integrate with upload-exam Edge Function
    - Handle multipart form data submission
    - Display individual file status
    - _Requirements: 2.5_

- [x] 12. Implement assessment dashboard
  - [x] 12.1 Create AssessmentDashboard component
    - Display exam list with aggregated submission stats
    - _Requirements: 8.1_
  - [x] 12.2 Create SubmissionList component
    - Table with status badges and scores
    - Support filtering by status and score range
    - _Requirements: 8.3, 8.5_
  - [x] 12.3 Create ResultViewer component
    - Display AI feedback, transcriptions, and score breakdown
    - _Requirements: 8.4_
  - [x] 12.4 Implement Supabase Realtime subscription
    - Subscribe to submission status changes
    - Update UI in real-time during grading
    - _Requirements: 8.2_
  - [ ]* 12.5 Write property test for dashboard aggregation
    - **Property 14: Dashboard aggregation correctness**
    - **Validates: Requirements 8.1, 8.3**
  - [ ]* 12.6 Write property test for filter correctness
    - **Property 15: Filter results correctness**
    - **Validates: Requirements 8.5**

- [x] 13. Implement access control
  - [x] 13.1 Verify RLS policies work correctly
    - Test educator can only see own exams
    - Test school admin can see school exams
    - _Requirements: 7.1, 7.2, 7.3, 7.4_
  - [x] 13.2 Write unit tests for access control logic
    - **Property 13: Access control returns only authorized data**
    - **Validates: Requirements 7.1, 7.3, 7.4**

- [x] 14. Final Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.
